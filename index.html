<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Checklist Camión PLBD87</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Ocultar el reporte de la vista normal */
        #hidden-report {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 700px;
            background: white;
            color: #1e293b;
        }

        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .report-grid {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
        }
    </style>
</head>
<body class="text-slate-900">

    <!-- INTERFAZ DE USUARIO -->
    <div id="app-container" class="min-h-screen pb-24">
        <header class="bg-white border-b sticky top-0 z-30 px-6 py-4 shadow-sm">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 17h4V5H2v12h3m15 0h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5v8h1"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                    </div>
                    <div>
                        <h1 class="font-black text-xl leading-none text-slate-800">PLBD87</h1>
                        <p class="text-[9px] font-black text-blue-500 uppercase tracking-[0.2em]">Checklist Diario</p>
                    </div>
                </div>
                <button onclick="exportarImagen()" id="btn-exportar" class="bg-slate-900 text-white px-5 py-2.5 rounded-2xl text-xs font-bold shadow-xl flex items-center gap-2 active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>EXPORTAR</span>
                </button>
            </div>
        </header>

        <main class="max-w-md mx-auto px-4 mt-6">
            <!-- Info Barra -->
            <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Fecha</span>
                    <span id="txt-fecha" class="font-bold text-slate-700">--/--/----</span>
                </div>
                <div class="h-8 w-px bg-slate-100"></div>
                <div class="flex flex-col text-right">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Hora</span>
                    <span id="txt-hora" class="font-bold text-slate-700">00:00</span>
                </div>
            </div>

            <!-- Lista interactiva -->
            <div id="lista-app" class="space-y-4 mb-8">
                <!-- Items inyectados por JS -->
            </div>

            <!-- Botón Agregar -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2 mb-2 block">Agregar Parámetro Extra</label>
                <div class="flex gap-2">
                    <input type="text" id="input-nuevo" placeholder="Ej: Neumáticos..." class="flex-1 bg-slate-50 border-none rounded-2xl px-5 py-3.5 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="agregarItem()" class="bg-blue-600 text-white p-3.5 rounded-2xl shadow-lg shadow-blue-100 active:scale-90">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- REPORTE DE EXPORTACIÓN (ESTILO HOJA WORD OPTIMIZADA SIN FIRMAS) -->
    <div id="hidden-report">
        <div class="p-12 bg-white">
            <!-- Header Reporte -->
            <div class="flex justify-between items-start border-b-4 border-slate-900 pb-8 mb-8">
                <div>
                    <p class="text-blue-600 font-black text-xs tracking-[0.3em] uppercase mb-2">Documento de Operaciones</p>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">Entrega del Camión Diario</h1>
                    <div class="mt-4 flex items-center gap-4">
                        <span class="bg-slate-900 text-white px-6 py-2 text-3xl font-mono font-black rounded-lg leading-none">PLBD87</span>
                    </div>
                </div>
                <div class="text-right flex flex-col justify-between h-24">
                    <div class="text-slate-400 font-bold text-[10px] uppercase tracking-widest">Información de Emisión</div>
                    <div>
                        <p id="rep-fecha" class="text-xl font-black text-slate-800"></p>
                        <p id="rep-hora" class="text-slate-500 font-bold text-sm"></p>
                    </div>
                </div>
            </div>

            <!-- Cuerpo del Reporte -->
            <div class="mb-4">
                <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Parámetros Verificados con Evidencia</h2>
                <div id="rep-items-container">
                    <!-- Solo ítems con foto -->
                </div>
            </div>

            <!-- Footer del Reporte -->
            <div class="mt-12 pt-8 border-t border-slate-100 flex justify-between items-center text-[8px] text-slate-300 font-black uppercase tracking-[0.4em]">
                <span>PLBD87 CONTROL DE FLOTA</span>
                <span>Generado digitalmente</span>
            </div>
        </div>
    </div>

    <!-- Inputs ocultos -->
    <input type="file" id="cam-input" accept="image/*" capture="environment" class="hidden">
    <input type="file" id="gal-input" accept="image/*" class="hidden">

    <script>
        let db = [
            { id: 1, label: 'Luces del camión', checked: false, photo: null },
            { id: 2, label: 'Llaves de candado', checked: false, photo: null },
            { id: 3, label: 'Luz de carrocería', checked: false, photo: null },
            { id: 4, label: 'Candado 1', checked: false, photo: null },
            { id: 5, label: 'Candado 2', checked: false, photo: null }
        ];

        let targetId = null;

        function updateTime() {
            const ahora = new Date();
            const d = ahora.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const h = ahora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('txt-fecha').innerText = d;
            document.getElementById('txt-hora').innerText = h;
            document.getElementById('rep-fecha').innerText = d;
            document.getElementById('rep-hora').innerText = h + ' HRS';
        }
        setInterval(updateTime, 1000);
        updateTime();

        function renderApp() {
            const list = document.getElementById('lista-app');
            list.innerHTML = '';
            db.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white rounded-3xl p-5 shadow-sm border border-slate-100";
                el.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleCheck(${item.id})">
                            <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.checked ? 'bg-emerald-500 border-emerald-500 shadow-lg shadow-emerald-100' : 'border-slate-200'}">
                                ${item.checked ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                            </div>
                            <span class="font-bold text-sm ${item.checked ? 'text-slate-300 line-through' : 'text-slate-700'}">${item.label}</span>
                        </div>
                        <button onclick="deleteItem(${item.id})" class="text-slate-200 hover:text-red-400 p-2"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>
                    ${item.photo ? `
                        <div class="relative rounded-2xl overflow-hidden border border-slate-100">
                            <img src="${item.photo}" class="w-full h-48 object-cover">
                            <button onclick="removePhoto(${item.id})" class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full shadow-lg"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>
                    ` : `
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="openCamera(${item.id})" class="flex flex-col items-center py-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-100 text-slate-400 hover:bg-blue-50 hover:text-blue-500 transition-all">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                <span class="text-[9px] font-black uppercase tracking-widest">Cámara</span>
                            </button>
                            <button onclick="openGal(${item.id})" class="flex flex-col items-center py-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-100 text-slate-400 hover:bg-emerald-50 hover:text-emerald-500 transition-all">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                <span class="text-[9px] font-black uppercase tracking-widest">Adjuntar</span>
                            </button>
                        </div>
                    `}
                `;
                list.appendChild(el);
            });
        }

        window.toggleCheck = (id) => { const i = db.find(x => x.id === id); i.checked = !i.checked; renderApp(); };
        window.removePhoto = (id) => { const i = db.find(x => x.id === id); i.photo = null; renderApp(); };
        window.deleteItem = (id) => { db = db.filter(x => x.id !== id); renderApp(); };
        window.agregarItem = () => {
            const inp = document.getElementById('input-nuevo');
            if (inp.value.trim()) {
                db.push({ id: Date.now(), label: inp.value.trim(), checked: false, photo: null });
                inp.value = '';
                renderApp();
            }
        };

        function openCamera(id) { targetId = id; document.getElementById('cam-input').click(); }
        function openGal(id) { targetId = id; document.getElementById('gal-input').click(); }

        function handleFile(e) {
            const file = e.target.files[0];
            if (file) {
                const lector = new FileReader();
                lector.onload = (evento) => {
                    const item = db.find(x => x.id === targetId);
                    item.photo = evento.target.result;
                    item.checked = true;
                    renderApp();
                };
                lector.readAsDataURL(file);
            }
            e.target.value = '';
        }

        document.getElementById('cam-input').addEventListener('change', handleFile);
        document.getElementById('gal-input').addEventListener('change', handleFile);

        async function exportarImagen() {
            const btn = document.getElementById('btn-exportar');
            btn.disabled = true;
            btn.innerText = 'PROCESANDO...';

            const contenedor = document.getElementById('rep-items-container');
            contenedor.innerHTML = '';

            // Filtrar solo ítems con foto
            const itemsConFoto = db.filter(item => item.photo !== null);

            if (itemsConFoto.length === 0) {
                alert("Debes adjuntar al menos una foto para generar el reporte.");
                btn.disabled = false;
                btn.innerText = 'EXPORTAR';
                return;
            }

            itemsConFoto.forEach((item, indice) => {
                const fila = document.createElement('div');
                fila.className = "report-grid";
                fila.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-6 h-6 bg-slate-100 flex items-center justify-center font-black text-slate-400 text-[10px] rounded">${indice + 1}</div>
                        <div class="flex flex-col">
                            <span class="text-sm font-black text-slate-800 uppercase tracking-tighter">${item.label}</span>
                            <span class="text-[9px] font-bold text-emerald-500 uppercase">Verificado ✓</span>
                        </div>
                    </div>
                    <div class="border-2 border-slate-50 rounded-lg overflow-hidden shadow-sm">
                        <img src="${item.photo}" class="w-full h-20 object-cover">
                    </div>
                `;
                contenedor.appendChild(fila);
            });

            try {
                const canvas = await html2canvas(document.getElementById('hidden-report'), {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });
                const link = document.createElement('a');
                link.download = `ENTREGA_PLBD87_${document.getElementById('txt-fecha').innerText.replace(/\//g, '-')}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (err) {
                console.error("Error al exportar:", err);
            }

            btn.disabled = false;
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>EXPORTAR</span>`;
        }

        renderApp();
    </script>
</body>
</html>

